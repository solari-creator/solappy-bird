<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Solappy Leaderboard</title>
<style>
/* --- Styles aynen kalƒ±yor --- */
body { font-family: monospace; background-color: #0d0d0d; color: #00ffcc; text-align: center; padding: 20px; overflow-x: hidden; }
h1 { color: #00ffcc; text-shadow: 0 0 10px #00ffcc; }
.stats-row { display: flex; justify-content: center; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
.stat-box { width: 180px; height: 80px; border: 2px solid #00ffcc; border-radius: 12px; padding: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; 
background-color: #111; color: #00ffcc; transition: transform 0.2s, box-shadow 0.3s; }
.stat-box:hover { transform: scale(1.05); box-shadow: 0 0 20px #14f0e8aa; }
.pulse { animation: pulseAnim 0.5s ease-out; }
@keyframes pulseAnim { 0%,100% { color: #00ffcc; } 50% { color: #14f0e8; text-shadow: 0 0 15px #14f0e8; } }
.stat-title { font-size: 12px; color: #14f0e8; margin-bottom: 5px; }
.stat-value { font-size: 16px; font-weight: bold; }
#heroOfDayBox { border-color: #ffcc00; animation: heroPulse 2s infinite alternate; }
@keyframes heroPulse { 0%{box-shadow:0 0 10px #ffcc00aa;} 50%{box-shadow:0 0 25px #ffcc00ee;} 100%{box-shadow:0 0 10px #ffcc00aa;} }
.leaderboard { margin-top: 30px; display: inline-block; text-align: left; border: 1px solid #00ffcc; padding: 20px; border-radius: 8px; box-shadow: 0 0 15px #00ffcc55; max-width: 700px; }
.leaderboard h2 { margin-top:0; margin-bottom:10px; color:#00ffcc; text-align:center; }
.top3 { color:#ffcc00; font-weight:bold; animation: top3Pulse 1.5s infinite alternate; }
.top4to10 { color:#14f0e8; font-weight:bold; }
@keyframes top3Pulse {0%{text-shadow:0 0 5px #ffcc00;} 50%{text-shadow:0 0 20px #ffcc00;} 100%{text-shadow:0 0 5px #ffcc00;}}
.player { display:flex; justify-content:space-between; align-items:center; margin-bottom:5px; }
.wallet { font-size: 14px; color: #fff; cursor: pointer; position: relative; }
.wallet:hover::after { content: attr(data-full); position: absolute; background: #111; border: 1px solid #00ffcc; border-radius: 5px; padding: 5px; color: #00ffcc; top: 20px; left: 0; white-space: 
nowrap; z-index: 10; }
.copied { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); background: #00ffcc; color: black; padding: 2px 5px; border-radius: 4px; font-size: 12px; opacity: 0; transition: 
opacity 0.2s; }
.sparkline { display: inline-block; width: 120px; height: 30px; margin-left: 10px; }
.extra-stats { margin-top: 20px; display:flex; justify-content:center; gap:10px; }
.extra-box { width: 180px; height: 60px; border:2px solid #00ffcc; border-radius:12px; display:flex; flex-direction:column; justify-content:center; align-items:center; background:#111; color:#00ffcc; 
}
.extra-title { font-size:12px; color:#14f0e8; margin-bottom:2px; }
.extra-value { font-size:14px; font-weight:bold; }
</style>
</head>
<body>
<h1>üèÜ Solappy Daily Leaderboard üèÜ</h1>

<!-- --- Top stats --- -->
<div class="stats-row">
  <div class="stat-box" id="heroOfDayBox">
    <div class="stat-title">Hero of the Day ü¶∏</div>
    <div class="stat-value" id="heroOfDay">Loading...</div>
  </div>
  <div class="stat-box">
    <div class="stat-title">Pot Wallet Treasury üí∞</div>
    <div class="stat-value" id="potWallet">0.0 SOL</div>
  </div>
  <div class="stat-box">
    <div class="stat-title">Time Left to Reward ‚è∞</div>
    <div class="stat-value" id="timeLeft">--:--:--</div>
  </div>
</div>

<!-- --- Bottom stats --- -->
<div class="extra-stats">
  <div class="extra-box">
    <div class="extra-title">Total Plays üéÆ</div>
    <div class="extra-value" id="totalPlays">0</div>
  </div>
  <div class="extra-box">
    <div class="extra-title">Total Players üë•</div>
    <div class="extra-value" id="totalPlayers">0</div>
  </div>
  <div class="extra-box">
    <div class="extra-title">Total Rewards ü™ô</div>
    <div class="extra-value" id="totalRewards">0 SOL</div>
  </div>
</div>

<div id="leaderboard" class="leaderboard">
  <h2>üèÖ Top 20 Players</h2>
  Loading leaderboard...
</div>

<audio id="heroSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_9a4b5f285d.mp3?filename=success-1-6297.mp3"></audio>

<script>
let lastHero = null;

function pulseValue(el, newValue){
  if(el.textContent !== newValue){
    el.textContent = newValue;
    el.classList.remove('pulse');
    void el.offsetWidth;
    el.classList.add('pulse');
  }
}

function drawSparkline(canvas,data){
  if(!data || !data.length) return;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const max = Math.max(...data);
  const min = Math.min(...data);
  ctx.beginPath();
  data.forEach((v,i)=>{
    const x = (i/(data.length-1))*canvas.width;
    const y = canvas.height - ((v-min)/(max-min))*canvas.height;
    i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
  });
  ctx.strokeStyle = '#00ffcc';
  ctx.lineWidth = 1.5;
  ctx.stroke();
}

async function fetchLeaderboard(){
  const res = await fetch('/scores');
  const data = await res.json();
  const leaderboard = document.getElementById('leaderboard');
  leaderboard.innerHTML='<h2>üèÖ Top 20 Players</h2>';

  let totalPlays = 0;
  const playersSet = new Set();
  const walletMap = {};

  data.forEach(p=>{
    totalPlays += p.plays || 1;
    if(!walletMap[p.wallet]){
      walletMap[p.wallet]={score:p.score, plays:p.plays||1, lastScores:p.lastScores||[p.score]};
    } else {
      walletMap[p.wallet].score=Math.max(walletMap[p.wallet].score,p.score);
      walletMap[p.wallet].plays+=p.plays||1;
      walletMap[p.wallet].lastScores.push(p.score);
    }
    playersSet.add(p.wallet);
  });

  const top20 = Object.entries(walletMap)
    .map(([wallet,val])=>({wallet,...val}))
    .sort((a,b)=>b.score - a.score)
    .slice(0,20);

  top20.forEach((p,i)=>{
    const row = document.createElement('div');
    row.style.display='flex';
    row.style.justifyContent='space-between';
    row.style.alignItems='center';
    row.style.marginBottom='5px';

    const leftDiv = document.createElement('div');
    const shortWallet = p.wallet.slice(0,4)+'...'+p.wallet.slice(-4);
    const walletSpan = document.createElement('span');
    walletSpan.className='wallet';
    walletSpan.textContent = `${shortWallet} (${p.plays})`;
    walletSpan.dataset.full = p.wallet;

    walletSpan.addEventListener('click',()=>{
      navigator.clipboard.writeText(p.wallet).then(()=>{
        const copied=document.createElement('div');
        copied.textContent='Copied!';
        copied.className='copied';
        walletSpan.appendChild(copied);
        setTimeout(()=>copied.style.opacity=1,10);
        setTimeout(()=>{copied.style.opacity=0; copied.remove()},800);
      });
    });

    leftDiv.appendChild(walletSpan);
    leftDiv.innerHTML+=` ‚Äî Score: ${p.score}`;
    if(i>=3 && i<10) leftDiv.classList.add('top4to10');

    const canvas=document.createElement('canvas');
    canvas.className='sparkline';
    canvas.width=120; canvas.height=30;
    drawSparkline(canvas,p.lastScores);

    row.appendChild(leftDiv);
    row.appendChild(canvas);
    leaderboard.appendChild(row);
  });

  pulseValue(document.getElementById('heroOfDay'),
    top20.length>0 ? top20[0].wallet.slice(0,4)+'...'+top20[0].wallet.slice(-4)+' ‚Äî '+top20[0].score : 'N/A');
  pulseValue(document.getElementById('totalPlays'),totalPlays);
  pulseValue(document.getElementById('totalPlayers'),playersSet.size);
}

async function fetchPotBalance(){
  try {
    const res = await fetch('/pot-balance');
    const data = await res.json();
    pulseValue(document.getElementById('potWallet'), `${data.balance} SOL`);
    
    // Toplam rewards
    const resRewards = await fetch('/rewards');
    const rewardsData = await resRewards.json();
    const totalRewardsSol = rewardsData.reduce((acc,r)=>acc+(r.lamports||0),0).toFixed(1);
    pulseValue(document.getElementById('totalRewards'), `${totalRewardsSol} SOL`);
  } catch(e){ console.error(e) }
}

function updateTimeLeft(){
  const now=new Date();
  const tomorrow=new Date();
  tomorrow.setHours(24,0,0,0);
  const diff = tomorrow-now;

  const hours=Math.floor(diff/1000/60/60);
  const minutes=Math.floor((diff/1000/60)%60);
  const seconds=Math.floor((diff/1000)%60);

  pulseValue(document.getElementById('timeLeft'),
    `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`);
}

fetchLeaderboard();
fetchPotBalance();
updateTimeLeft();
setInterval(fetchLeaderboard,10000);
setInterval(fetchPotBalance,60*1000); // her dakika g√ºncelle
setInterval(updateTimeLeft,1000);
</script>
</body>
</html>
