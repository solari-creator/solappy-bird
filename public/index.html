<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Solappy Leaderboard</title>
<style>
body { font-family: monospace; background:#0d0d0d; color:#00ffcc; text-align:center; padding:20px; overflow-x:hidden; margin:0; }
h1 { color:#00ffcc; text-shadow:0 0 10px #00ffcc; margin-bottom:10px; }
.tabs { display:flex; justify-content:center; gap:10px; margin-bottom:15px; }
.tab { padding:8px 16px; border:2px solid #00ffcc; border-radius:8px; cursor:pointer; transition:0.2s; }
.tab.active { background:#00ffcc; color:#0d0d0d; }
.stats-row { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-bottom:20px; }
.stat-box { width:180px; height:80px; border:2px solid #00ffcc; border-radius:12px; display:flex; flex-direction:column; justify-content:center; align-items:center; background:#111; color:#00ffcc; 
transition: transform 0.2s, box-shadow 0.3s; position:relative; }
.stat-box:hover { transform:scale(1.05); box-shadow:0 0 20px #14f0e8aa; }
.pulse { animation:pulseAnim 0.5s ease-out; }
@keyframes pulseAnim {0%,100%{color:#00ffcc} 50%{color:#14f0e8; text-shadow:0 0 15px #14f0e8}}
.stat-title { font-size:12px; color:#14f0e8; margin-bottom:5px; }
.stat-value { font-size:16px; font-weight:bold; }
#heroBox { border-color:#ffcc00; animation:heroPulse 2s infinite alternate; }
@keyframes heroPulse {0%{box-shadow:0 0 10px #ffcc00aa} 50%{box-shadow:0 0 25px #ffcc00ee} 100%{box-shadow:0 0 10px #ffcc00aa}}
.leaderboard { margin:20px auto; display:inline-block; text-align:left; border:1px solid #00ffcc; padding:20px; border-radius:8px; box-shadow:0 0 15px #00ffcc55; max-width:700px; overflow:hidden; }
.leaderboard h2 { margin-top:0; margin-bottom:10px; color:#00ffcc; text-align:center; }
.top3 { font-weight:bold; animation:top3Pulse 1.5s infinite alternate; }
.gold { color:#FFD700; text-shadow:0 0 8px #FFD700; }
.silver { color:#C0C0C0; text-shadow:0 0 6px #C0C0C0; }
.bronze { color:#CD7F32; text-shadow:0 0 4px #CD7F32; }
.top4to10 { color:#14f0e8; font-weight:bold; }
@keyframes top3Pulse {0%{text-shadow:0 0 5px #ffcc00} 50%{text-shadow:0 0 20px #ffcc00} 100%{text-shadow:0 0 5px #ffcc00;}}
.player { display:flex; justify-content:space-between; align-items:center; margin-bottom:5px; }
.wallet { font-size:14px; color:#fff; cursor:pointer; position:relative; }
.wallet:hover::after { content:attr(data-full) " | Plays: " attr(data-plays) " | Raw: " attr(data-score) " | Fair: " attr(data-fair); position:absolute; background:#111; border:1px solid #00ffcc; 
border-radius:5px; padding:5px; color:#00ffcc; top:20px; left:0; white-space:nowrap; z-index:10; }
.copied { position:absolute; top:-20px; left:50%; transform:translateX(-50%); background:#00ffcc; color:black; padding:2px 5px; border-radius:4px; font-size:12px; opacity:0; transition:opacity 0.2s; }
.extra-stats { margin-top:20px; display:flex; justify-content:center; gap:10px; }
.extra-box { width:180px; height:60px; border:2px solid #00ffcc; border-radius:12px; display:flex; flex-direction:column; justify-content:center; align-items:center; background:#111; color:#00ffcc; }
.extra-title { font-size:12px; color:#14f0e8; margin-bottom:2px; }
.extra-value { font-size:14px; font-weight:bold; }
.progress-bar { width:100%; background:#222; border-radius:8px; overflow:hidden; height:12px; margin-top:5px; }
.progress-fill { background:#14f0e8; height:100%; width:0%; transition: width 1s ease; }
</style>
</head>
<body>

<h1>üèÜ Solappy Leaderboard üèÜ</h1>

<div class="tabs">
  <div class="tab active" data-range="daily">Daily</div>
  <div class="tab" data-range="weekly">Weekly</div>
  <div class="tab" data-range="monthly">Monthly</div>
</div>

<div class="stats-row">
  <div class="stat-box" id="heroBox">
    <div class="stat-title" id="heroTitle">Hero of the Day ü¶∏</div>
    <div class="stat-value" id="hero">Loading...</div>
  </div>
  <div class="stat-box">
    <div class="stat-title">Pot Wallet Treasury üí∞</div>
    <div class="stat-value" id="potWallet">0.0 SOL</div>
  </div>
  <div class="stat-box">
    <div class="stat-title">Time Left to Reward ‚è∞</div>
    <div class="stat-value" id="timeLeft">--:--:--</div>
    <div class="progress-bar"><div class="progress-fill" id="timeProgress"></div></div>
  </div>
</div>

<div class="extra-stats">
  <div class="extra-box">
    <div class="extra-title">Total Plays üéÆ</div>
    <div class="extra-value" id="totalPlays">0</div>
  </div>
  <div class="extra-box">
    <div class="extra-title">Total Players üë•</div>
    <div class="extra-value" id="totalPlayers">0</div>
  </div>
  <div class="extra-box">
    <div class="extra-title">Total Rewards ü™ô</div>
    <div class="extra-value" id="totalRewards">0 SOL</div>
  </div>
</div>

<div id="leaderboard" class="leaderboard">
  <h2>üèÖ Top 20 Players</h2>
  Loading leaderboard...
</div>

<div id="winners">
  <h2>üèÖ Last Reward Winners</h2>
  <table>
    <thead>
      <tr><th>Date</th><th>Wallet</th><th>Reward (SOL)</th><th>Tx</th></tr>
    </thead>
    <tbody id="winnerList"></tbody>
  </table>
</div>

<audio id="heroSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_9a4b5f285d.mp3?filename=success-1-6297.mp3"></audio>
<canvas id="confettiCanvas" style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none;"></canvas>

<script>
let currentRange='daily', lastHero=null
const confettiCanvas=document.getElementById('confettiCanvas')
const confettiCtx=confettiCanvas.getContext('2d')
confettiCanvas.width=window.innerWidth
confettiCanvas.height=window.innerHeight
let confettiParticles=[]

function createConfetti(count=100){
  for(let i=0;i<count;i++){confettiParticles.push({
    x:Math.random()*confettiCanvas.width,
    y:Math.random()*confettiCanvas.height,
    r:Math.random()*6+4,
    d:Math.random()*50+10,
    color:`hsl(${Math.random()*360},100%,50%)`,
    tilt:Math.random()*10-5,
    tiltAngleIncrement:Math.random()*0.07+0.05
  })}
}

function drawConfetti(){
  confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height)
  confettiParticles.forEach(p=>{
    confettiCtx.beginPath()
    confettiCtx.lineWidth=p.r/2
    confettiCtx.strokeStyle=p.color
    confettiCtx.moveTo(p.x+p.tilt+p.r/4,p.y)
    confettiCtx.lineTo(p.x+p.tilt,p.y+p.tilt+p.r/4)
    confettiCtx.stroke()
  })
  confettiParticles.forEach(p=>{
    p.tiltAngle+=p.tiltAngleIncrement
    p.y+=(Math.cos(p.d)+3+p.r/2)/2
    p.x+=Math.sin(p.tiltAngle)
    if(p.y>confettiCanvas.height){p.y=-10;p.x=Math.random()*confettiCanvas.width}
  })
  requestAnimationFrame(drawConfetti)
}

function fairScore(raw,plays){return Math.round(raw/(1+Math.log(plays+1)*0.25))}

async function fetchLeaderboard(range=currentRange){
  try{
    const res=await fetch(`/scores?range=${range}`)
    const data=await res.json()
    const leaderboard=document.getElementById('leaderboard')
    leaderboard.innerHTML='<h2>üèÖ Top 20 Players</h2>'
    const walletMap={}
    data.forEach(s=>{
      if(!walletMap[s.wallet]) walletMap[s.wallet]={rawScore:s.score,plays:1,lastScores:[s.score]}
      else { walletMap[s.wallet].rawScore=Math.max(walletMap[s.wallet].rawScore,s.score); walletMap[s.wallet].plays++; walletMap[s.wallet].lastScores.push(s.score) }
    })
    const list=Object.entries(walletMap).map(([wallet,val])=>{
      const fair=fairScore(val.rawScore,val.plays)
      return {wallet,raw:val.rawScore,plays:val.plays,fair,lastScores:val.lastScores}
    }).sort((a,b)=>b.fair-a.fair).slice(0,20)

    list.forEach((p,i)=>{
      const row=document.createElement('div'); row.className='player'
      const left=document.createElement('div')
      const short=p.wallet.slice(0,4)+'...'+p.wallet.slice(-4)
      left.innerHTML=`${short} (${p.plays}) ‚Äî Raw:${p.raw} / Fair:${p.fair}`
      if(i==0) left.classList.add('gold')
      else if(i==1) left.classList.add('silver')
      else if(i==2) left.classList.add('bronze')
      else if(i<10) left.classList.add('top4to10')
      const canvas=document.createElement('canvas'); canvas.width=120; canvas.height=30
      const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height)
      const max=Math.max(...p.lastScores), min=Math.min(...p.lastScores)
      ctx.beginPath()
      p.lastScores.forEach((v,idx)=>{
        const x=(idx/(p.lastScores.length-1))*canvas.width
        const y=canvas.height-((v-min)/(max-min))*canvas.height
        idx===0?ctx.moveTo(x,y):ctx.lineTo(x,y)
      })
      ctx.strokeStyle=p.lastScores[p.lastScores.length-1]>=p.lastScores[p.lastScores.length-2]?'#00ff00':'#ff4d4d'
      ctx.lineWidth=1.5; ctx.stroke()
      row.appendChild(left)
      row.appendChild(canvas)
      leaderboard.appendChild(row)
    })

    const hero=document.getElementById('hero')
    hero.textContent=list.length>0?list[0].wallet.slice(0,4)+'...'+list[0].wallet.slice(-4)+' ‚Äî '+list[0].fair:'N/A'
    document.getElementById('heroTitle').textContent=`Hero of the ${range.charAt(0).toUpperCase()+range.slice(1)} ü¶∏`
    if(lastHero!==list[0]?.wallet && lastHero!==null){document.getElementById('heroSound').play(); createConfetti(100); drawConfetti()}
    lastHero=list[0]?.wallet
  }catch(e){console.error(e)}
}

async function fetchTotals(){
  try{const r=await fetch('/totals'); const d=await r.json()
    document.getElementById('totalPlays').textContent=d.totalPlays
    document.getElementById('totalPlayers').textContent=d.totalPlayers
  }catch(e){console.error(e)}
}

async function fetchPot(){
  try{
    const r=await fetch('/pot-balance'); const d=await r.json(); document.getElementById('potWallet').textContent=`${d.balance} SOL`
    const r2=await fetch('/rewards'); const dr=await r2.json()
    const tot=dr.reduce((a,b)=>a+(b.lamports||0),0).toFixed(1); document.getElementById('totalRewards').textContent=`${tot} SOL`
    const wl=document.getElementById('winnerList'); wl.innerHTML=''
    dr.reverse().slice(0,10).forEach(w=>{
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${new Date(w.date).toLocaleString()}</td><td>${w.wallet.slice(0,4)}...${w.wallet.slice(-4)}</td><td>${w.lamports}</td><td><a 
href="https://solscan.io/tx/${w.tx}?cluster=mainnet" target="_blank">${w.tx?'View':'-'}</a></td>`; wl.appendChild(tr)
    })
  }catch(e){console.error(e)}
}

function updateTime(){
  const now=new Date(); const nxt=new Date(Date.UTC(now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate()+1,0,0,0))
  const diff=nxt-now
  const h=Math.floor(diff/36e5), m=Math.floor(diff/6e4)%60, s=Math.floor(diff/1e3)%60
  document.getElementById('timeLeft').textContent=`${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`
  document.getElementById('timeProgress').style.width=`${(86400-diff/1000)/864}%`
}

document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'))
  t.classList.add('active')
  currentRange=t.dataset.range; lastHero=null; fetchLeaderboard(currentRange)
}))

fetchLeaderboard(); fetchTotals(); fetchPot(); updateTime()
setInterval(fetchLeaderboard,10000); setInterval(fetchTotals,60000); setInterval(fetchPot,60000); setInterval(updateTime,1000)
</script>
</body>
</html>
